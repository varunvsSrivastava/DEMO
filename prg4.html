CREATE TABLE Department2(
    dname VARCHAR(50) ,
    dnumber INT PRIMARY KEY UNIQUE NOT NULL,
    mgr_ssn CHAR(9),
    mgr_start_date DATE
);

CREATE TABLE Employee2 (
    ssn CHAR(9) PRIMARY KEY,
    fname VARCHAR(30) NOT NULL,
    lname VARCHAR(30) NOT NULL,
    bdate DATE,
    address VARCHAR(255),
    sex CHAR(1),
    salary DECIMAL(10,2),
    superssn CHAR(9),
    dno INT,
    FOREIGN KEY (superssn) REFERENCES Employee(ssn) ON DELETE SET NULL, -- set all employees-superssn to null, who come under him, ....
    FOREIGN KEY (dno) REFERENCES Department(dnumber) ON DELETE CASCADE  --


);

CREATE TABLE Project2 (
    pname VARCHAR(50) PRIMARY KEY,
    pnumber INT UNIQUE NOT NULL,
    plocation VARCHAR(100),
    dnum INT,
    ssn char(9),
    FOREIGN KEY (dnum) REFERENCES Department2(dnumber) ON DELETE CASCADE,
    FOREIGN KEY (ssn) REFERENCES Employee2(ssn)
);

CREATE TABLE Works_On2 (
    essn CHAR(9),
    pno INT,
    hours DECIMAL(4,1),
    PRIMARY KEY (essn, pno),
    FOREIGN KEY (essn) REFERENCES Employee2(ssn) ON DELETE CASCADE,
    FOREIGN KEY (pno) REFERENCES Project2(pnumber) ON DELETE CASCADE
);

CREATE TABLE Dependent2 (
    essn CHAR(9),
    dependent_name VARCHAR(50),
    sex CHAR(1),
    bdate DATE,
    relationship VARCHAR(50),
    PRIMARY KEY (essn, dependent_name),
    FOREIGN KEY (essn) REFERENCES Employee2(ssn) ON DELETE CASCADE
);



INSERT INTO Department2 (dname, dnumber, mgr_ssn, mgr_start_date) VALUES
('Finance', 101, '111', '2015-06-12'),
('Human Resources', 102, '112', '2018-09-25'),
('IT', 103, '113', '2017-03-14'),
('Marketing', 104, '114', '2019-07-01'),
('R&D', 105, '115', '2019-08-01');



INSERT INTO Employee2 (ssn, fname, lname, bdate, address, sex, salary, superssn, dno) VALUES
('111', 'Ravi', 'Sharma', '1980-05-15', '123, MG Road, Mumbai, Maharashtra', 'M', 80000.00, null, 101),
('112', 'Anita', 'Iyer', '1985-07-20', '56, Brigade Road, Bangalore, Karnataka', 'F', 75000.00, '111', 102),
('113', 'Venkata', 'Reddy', '2005-03-17', 'RR Nagar Main Road, Bangalore, Karnataka', 'M', 75000.00, '112', 102),
('114', 'Ajay', 'Rao', '1985-07-20', 'Basavanagudi, Bangalore, Karnataka', 'M', 5000.00, '113', 102),
('115', 'Vikram', 'Singh', '1990-02-10', '78, Anna Nagar, Chennai, Tamil Nadu', 'M', 90000.00, '114', 103),



ALTER Table Department2 add constraint FOREIGN KEY (mgr_ssn) REFERENCES Employee2(ssn);



INSERT INTO Project2 (pname, pnumber, plocation, dnum,ssn) VALUES
('Banking System Upgrade', 201, 'Mumbai', 101,'112'),
('Employee Portal', 202, 'Bangalore', 102,'120'),
('Cyber Security Enhancement', 203, 'Delhi', 103,'121'),
('Digital Marketing Campaign', 204, 'Kolkata', 105,'123'),
('Retail Management System', 205, 'Delhi', 105,'121'),
('AI Research Lab', 206, 'Hyderabad', 105,'113'),
('Data Science',207,'Mumbai',102,'119');

INSERT INTO Works_On2 (essn, pno, hours) VALUES
('111', 201, 40.0),
('112', 202, 35.5),
('113', 203, 42.0),
('114', 204, 38.0),
('115', 205, 45.0),
('111', 205, 20.0),
('112', 205, 15.5),
('115', 204, 20.0),
('115', 206, 25.0),
('120', 205, 30.0),
('121', 206, 25.0),
('122', 204, 35.0),
('122', 206, 20.0),
('123', 206, 40.0);


INSERT INTO Dependent2 (essn, dependent_name, sex, bdate, relationship) VALUES
('111', 'Sanya Sharma', 'F', '2010-08-15', 'Daughter'),
('112', 'Rohan Iyer', 'M', '2012-11-20', 'Son'),
('113', 'Aarav Verma', 'M', '2016-04-10', 'Son'),
('114', 'Pranavi Verma', 'F', '2020-03-11', 'Daughter'),
('115', 'Sunita G', 'F', '1987-09-25', 'Spouse'),
('115', 'Sunil Gupta', 'M', '2015-06-12', 'Son');




select *from Employee2;
select * from Dependent2;
select * from Department2;
Select * from project2;
select * from Works_On2;

SELECT e.fname, e.lname, e.salary, d.dname
FROM Employee2 e
JOIN Department2 d ON e.dno = d.dnumber
WHERE e.salary > (
    SELECT AVG(e2.salary)
    FROM Employee2 e2
    JOIN Department2 d2 ON e2.dno = d2.dnumber
    WHERE d2.dname = 'Finance'
);


SELECT AVG(e.salary) AS avg_finance_salary
FROM Employee2 e
JOIN Department2 d ON e.dno = d.dnumber
WHERE d.dname = 'Finance';



SELECT e.fname, e.lname, d.dname, COUNT(w.pno) AS project_count
FROM Works_On2 w
JOIN Project2 p ON w.pno = p.pnumber
JOIN Employee2 e ON w.essn = e.ssn
JOIN Department2 d ON p.dnum = d.dnumber
WHERE d.dname = 'R&D'
GROUP BY e.ssn, e.fname, e.lname, d.dname
HAVING COUNT(w.pno) > 2;


ALTER TABLE Project2 ADD date_of_completion DATE;

UPDATE Project2 SET date_of_completion = '2025-01-30' WHERE pnumber = 201;
UPDATE Project2 SET date_of_completion = '2025-03-15' WHERE pnumber = 202;
UPDATE Project2 SET date_of_completion = '2026-03-10' WHERE pnumber = 203;
UPDATE Project2 SET date_of_completion = '2025-02-20' WHERE pnumber = 204;
UPDATE Project2 SET date_of_completion = '2028-01-05' WHERE pnumber = 205;
UPDATE Project2 SET date_of_completion = '2026-08-12' WHERE pnumber = 206;
update Project2 set date_of_completion= '2026-08-12' where pnumber =207;
SELECT
    p.pnumber AS project_id,
    p.pname AS title,
    d.dname AS dept_name,
    p.date_of_completion,
    IF(p.date_of_completion >= CURDATE(), 'Ongoing', 'Completed') AS status
FROM Project2 p
JOIN Department2 d ON p.dnum = d.dnumber;



SELECT e.superssn AS supervisor_id, s.fname AS supervisor_fname, s.lname AS supervisor_lname
FROM Employee2 e
JOIN Employee2 s ON e.superssn = s.ssn
WHERE e.ssn IN (
    SELECT DISTINCT w.essn FROM Works_On2 w
)
GROUP BY e.superssn, s.fname, s.lname
HAVING COUNT(DISTINCT e.ssn) > 3;



ALTER TABLE Project2 ADD COLUMN budget DECIMAL(12,2);
UPDATE Project2 SET budget = 500000 WHERE pnumber = 201;
UPDATE Project2 SET budget = 700000 WHERE pnumber = 202;
UPDATE Project2 SET budget = 300000 WHERE pnumber = 203;
UPDATE Project2 SET budget = 900000 WHERE pnumber = 204;
UPDATE Project2 SET budget = 200000 WHERE pnumber = 205;
UPDATE Project2 SET budget = 600000 WHERE pnumber = 206;
update Project2 set budget= 900000 where pnumber = 207;
SELECT e.ssn AS emp_id,
       e.fname AS emp_name,
       SUM(p.budget) AS project_amt,
       d.dependent_name
FROM Works_On2 w
JOIN Project2 p ON w.pno = p.pnumber
JOIN Employee2 e ON w.essn = e.ssn
JOIN Dependent2 d ON e.ssn = d.essn
GROUP BY e.ssn, e.fname, d.dependent_name
HAVING SUM(p.budget) >= 1000000;








SELECT DISTINCT e.ssn AS emp_id,e.fname as name,
                e.dno AS dep_id,
                p.pnumber AS proj_id,
                p.plocation AS city
FROM Works_On2 w
JOIN Project2 p ON w.pno = p.pnumber
JOIN Employee2 e ON w.essn = e.ssn
WHERE p.pnumber IN (
    SELECT pnumber
    FROM Project2
    GROUP BY pnumber
    HAVING COUNT(DISTINCT plocation) >= 1
);






CREATE TABLE Department2 (
    dname VARCHAR(50) ,
    dnumber INT PRIMARY KEY UNIQUE NOT NULL,
    mgr_ssn CHAR(9),
    mgr_start_date DATE
);

CREATE TABLE Employee2 (
    ssn CHAR(9) PRIMARY KEY,
    fname VARCHAR(30) NOT NULL,
    lname VARCHAR(30) NOT NULL,
    bdate DATE,
    address VARCHAR(255),
    sex CHAR(1),
    salary DECIMAL(10,2),
    superssn CHAR(9),
    dno INT,
    FOREIGN KEY (superssn) REFERENCES Employee2(ssn) ON DELETE SET NULL, -- set all employees-superssn to null, who come under him, ....
    FOREIGN KEY (dno) REFERENCES Department2(dnumber) ON DELETE CASCADE  --
);

CREATE TABLE Project2 (
    pname VARCHAR(50) PRIMARY KEY,
    pnumber INT UNIQUE NOT NULL,
    plocation VARCHAR(100),
    dnum INT,
    ssn char(9),
    FOREIGN KEY (dnum) REFERENCES Department2(dnumber) ON DELETE CASCADE,
    FOREIGN KEY (ssn) REFERENCES Employee2(ssn)
);

CREATE TABLE Works_On2 (
    essn CHAR(9),
    pno INT,
    hours DECIMAL(4,1),
    PRIMARY KEY (essn, pno),
    FOREIGN KEY (essn) REFERENCES Employee2(ssn) ON DELETE CASCADE,
    FOREIGN KEY (pno) REFERENCES Project2(pnumber) ON DELETE CASCADE
);

CREATE TABLE Dependent2 (
    essn CHAR(9),
    dependent_name VARCHAR(50),
    sex CHAR(1),
    bdate DATE,
    relationship VARCHAR(50),
    PRIMARY KEY (essn, dependent_name),
    FOREIGN KEY (essn) REFERENCES Employee2(ssn) ON DELETE CASCADE
);



INSERT INTO Department2 (dname, dnumber, mgr_ssn, mgr_start_date) VALUES
('Finance', 101, '111', '2015-06-12'),
('Human Resources', 102, '112', '2018-09-25'),
('IT', 103, '113', '2017-03-14'),
('Marketing', 104, '114', '2019-07-01'),
('R&D', 105, '115', '2019-08-01');



INSERT INTO Employee2 (ssn, fname, lname, bdate, address, sex, salary, superssn, dno) VALUES
('111', 'Ravi', 'Sharma', '1980-05-15', '123, MG Road, Mumbai, Maharashtra', 'M', 80000.00, null, 101),
('112', 'Anita', 'Iyer', '1985-07-20', '56, Brigade Road, Bangalore, Karnataka', 'F', 75000.00, '111', 102),
('113', 'Venkata', 'Reddy', '2005-03-17', 'RR Nagar Main Road, Bangalore, Karnataka', 'M', 75000.00, '112', 102),
('114', 'Ajay', 'Rao', '1985-07-20', 'Basavanagudi, Bangalore, Karnataka', 'M', 5000.00, '113', 102),
('115', 'Vikram', 'Singh', '1990-02-10', '78, Anna Nagar, Chennai, Tamil Nadu', 'M', 90000.00, '114', 103),
('116', 'Priya', 'Verma', '1993-09-05', '90, Salt Lake, Kolkata, West Bengal', 'F', 72000.00, '113', 104),
('117', 'Amit','Gupta', '1988-11-12', '101, Connaught Place, Delhi', 'M', 85000.00, '114', 105),
('118', 'Arun', 'Sharma', '1989-11-12', '10, Munnar Place, Delhi', 'M', 85000.00, '115', 105),
('119', 'Rajiv', 'Gupta', '1990-01-11', '104, Main road, Delhi', 'M', 50000.00, '115', 105),
('120', 'Suresh', 'Kumar', '1992-01-01', 'Chennai, Tamil Nadu', 'M', 60000.00, '115', 105),
('121', 'Neha', 'Sharma', '1993-02-15', 'Delhi, India', 'F', 62000.00, '115', 105),
('122', 'Rohan', 'Joshi', '1995-06-10', 'Mumbai, India', 'M', 58000.00, '115', 105),
('123', 'Karan', 'Singh', '1991-08-25', 'Pune, India', 'M', 62000.00, '115', 105);

update Project2 set ssn=112 where pnumber=201;
update Project2 set ssn=113 where pnumber=206;
update Project2 set ssn=121 where pnumber=203;
update Project2 set ssn=116 where pnumber=207;
update Project2 set ssn=120 where pnumber=202;
update Project2 set ssn=121 where pnumber=205;
ALTER Table Department2 add constraint FOREIGN KEY (mgr_ssn) REFERENCES Employee2(ssn);

INSERT INTO Project2 (pname, pnumber, plocation, dnum) VALUES
('Banking System Upgrade', 201, 'Mumbai', 101),
('Employee Portal', 202, 'Bangalore', 102),
('Cyber Security Enhancement', 203, 'Delhi', 103),
('Digital Marketing Campaign', 204, 'Kolkata', 105),
('Retail Management System', 205, 'Delhi', 105),
('AI Research Lab', 206, 'Hyderabad', 105),
('Data Science',207,'Mumbai',101);
drop table Project2;
INSERT INTO Works_On2 (essn, pno, hours) VALUES
('111', 201, 40.0),
('112', 202, 35.5),
('113', 203, 42.0),
('114', 204, 38.0),
('115', 205, 45.0),
('111', 205, 20.0),
('112', 205, 15.5),
('115', 204, 20.0),
('115', 206, 25.0),
('120', 205, 30.0),
('121', 206, 25.0),
('122', 204, 35.0),
('122', 206, 20.0),
('123', 206, 40.0);


INSERT INTO Dependent2 (essn, dependent_name, sex, bdate, relationship) VALUES
('111', 'Sanya Sharma', 'F', '2010-08-15', 'Daughter'),
('112', 'Rohan Iyer', 'M', '2012-11-20', 'Son'),
('113', 'Aarav Verma', 'M', '2016-04-10', 'Son'),
('114', 'Pranavi Verma', 'F', '2020-03-11', 'Daughter'),
('115', 'Sunita G', 'F', '1987-09-25', 'Spouse'),
('115', 'Sunil Gupta', 'M', '2015-06-12', 'Son');




select *from Employee2;
select * from Dependent2;
select * from Department2;
Select * from project2;
select * from Works_On2;

SELECT e.fname, e.lname, e.salary, d.dname
FROM Employee2 e
JOIN Department2 d ON e.dno = d.dnumber
WHERE e.salary > (
    SELECT AVG(e2.salary)
    FROM Employee2 e2
    JOIN Department2 d2 ON e2.dno = d2.dnumber
    WHERE d2.dname = 'Finance'
);


SELECT AVG(e.salary) AS avg_finance_salary
FROM Employee2 e
JOIN Department2 d ON e.dno = d.dnumber
WHERE d.dname = 'Finance';



SELECT e.fname, e.lname, d.dname, COUNT(w.pno) AS project_count
FROM Works_On2 w
JOIN Project2 p ON w.pno = p.pnumber
JOIN Employee2 e ON w.essn = e.ssn
JOIN Department2 d ON p.dnum = d.dnumber  -- Fetch department from Project, NOT Employee
WHERE d.dname = 'R&D'  -- Ensure only R&D projects are considered
GROUP BY e.ssn, e.fname, e.lname, d.dname
HAVING COUNT(w.pno) > 2;


ALTER TABLE Project2 ADD date_of_completion DATE;

UPDATE Project2 SET date_of_completion = '2025-01-30' WHERE pnumber = 201;
UPDATE Project2 SET date_of_completion = '2025-03-15' WHERE pnumber = 202;
UPDATE Project2 SET date_of_completion = '2026-03-10' WHERE pnumber = 203;
UPDATE Project2 SET date_of_completion = '2025-02-20' WHERE pnumber = 204;
UPDATE Project2 SET date_of_completion = '2028-01-05' WHERE pnumber = 205;
UPDATE Project2 SET date_of_completion = '2026-08-12' WHERE pnumber = 206;
update Project2 set date_of_completion= '2026-08-12' where pnumber =207;
SELECT
    p.pnumber AS project_id,
    p.pname AS title,
    d.dname AS dept_name,
    p.date_of_completion,
    IF(p.date_of_completion >= CURDATE(), 'Ongoing', 'Completed') AS status
FROM Project2 p
JOIN Department2 d ON p.dnum = d.dnumber;



SELECT e.superssn AS supervisor_id, s.fname AS supervisor_fname, s.lname AS supervisor_lname
FROM Employee2 e
JOIN Employee2 s ON e.superssn = s.ssn
WHERE e.ssn IN (
    SELECT DISTINCT w.essn FROM Works_On2 w
)
GROUP BY e.superssn, s.fname, s.lname
HAVING COUNT(DISTINCT e.ssn) > 3;



ALTER TABLE Project2 ADD COLUMN budget DECIMAL(12,2);
UPDATE Project2 SET budget = 500000 WHERE pnumber = 201;
UPDATE Project2 SET budget = 700000 WHERE pnumber = 202;
UPDATE Project2 SET budget = 300000 WHERE pnumber = 203;
UPDATE Project2 SET budget = 900000 WHERE pnumber = 204;
UPDATE Project2 SET budget = 200000 WHERE pnumber = 205;
UPDATE Project2 SET budget = 600000 WHERE pnumber = 206;
update Project2 set budget= 900000 where pnumber = 207;
SELECT e.ssn AS emp_id,
       e.fname AS emp_name,
       SUM(p.budget) AS project_amt,
       d.dependent_name
FROM Works_On2 w
JOIN Project2 p ON w.pno = p.pnumber
JOIN Employee2 e ON w.essn = e.ssn
JOIN Dependent2 d ON e.ssn = d.essn
GROUP BY e.ssn, e.fname, d.dependent_name
HAVING SUM(p.budget) >= 1000000;



SELECT DISTINCT e.ssn AS emp_id,e.fname as name,
                e.dno AS dep_id,
                p.pnumber AS proj_id,
                p.plocation AS city
FROM Works_On2 w
JOIN Project2 p ON w.pno = p.pnumber
JOIN Employee2 e ON w.essn = e.ssn
WHERE p.ssn IN (
    SELECT pnumber
    FROM Project2
    GROUP BY fname
    HAVING COUNT(DISTINCT plocation) >= 1
);
